name: Build USB Chief Driver

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        arch: [x64, x86]
        configuration: [Debug, Release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Install Windows DDK 7.1.0 (7600.16385.1)
      shell: powershell
      run: |
        Write-Host "Downloading Windows DDK 7.1.0..."
        # Download Windows 7 WDK ISO (version 7600.16385.1)
        $ddkUrl = "https://download.microsoft.com/download/4/A/2/4A25C7D5-EFBE-4182-B6A9-AE6850409A78/GRMWDK_EN_7600_1.ISO"
        $ddkIso = "$env:TEMP\GRMWDK_EN_7600_1.ISO"
        Invoke-WebRequest -Uri $ddkUrl -OutFile $ddkIso -UseBasicParsing
        
        Write-Host "Mounting ISO..."
        $mount = Mount-DiskImage -ImagePath $ddkIso -PassThru
        $driveLetter = ($mount | Get-Volume).DriveLetter
        
        Write-Host "Installing DDK from ${driveLetter}:..."
        $setupPath = "${driveLetter}:\KitSetup.exe"
        
        # Install DDK silently to C:\WinDDK\7600.16385.1
        Start-Process -FilePath $setupPath -ArgumentList "/auto", "C:\WinDDK\7600.16385.1" -Wait -NoNewWindow
        
        Write-Host "Dismounting ISO..."
        Dismount-DiskImage -ImagePath $ddkIso
        
        Write-Host "DDK installation complete"
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.27.x'
    
    - name: Locate DDK installation
      id: wdk-path
      shell: powershell
      run: |
        # Check for Windows 7 DDK installation
        $ddkPath = "C:\WinDDK\7600.16385.1"
        
        if (Test-Path $ddkPath) {
          Write-Host "Found DDK at: $ddkPath"
          echo "WDK_ROOT=$ddkPath" >> $env:GITHUB_OUTPUT
          echo "WDK_VERSION=7600.16385.1" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "DDK not found at $ddkPath"
          exit 1
        }
    
    - name: Configure CMake (x64)
      if: matrix.arch == 'x64'
      shell: powershell
      run: |
        $wdkRoot = "${{ steps.wdk-path.outputs.WDK_ROOT }}"
        $wdkVersion = "${{ steps.wdk-path.outputs.WDK_VERSION }}"
        
        # Set up environment for x64 build
        cmake -B build `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DSDK_ROOT="$wdkRoot" `
          -DCMAKE_BUILD_TYPE=${{ matrix.configuration }}
    
    - name: Configure CMake (x86)
      if: matrix.arch == 'x86'
      shell: powershell
      run: |
        $wdkRoot = "${{ steps.wdk-path.outputs.WDK_ROOT }}"
        $wdkVersion = "${{ steps.wdk-path.outputs.WDK_VERSION }}"
        
        # Set up environment for x86 build
        cmake -B build `
          -G "Visual Studio 17 2022" `
          -A Win32 `
          -DSDK_ROOT="$wdkRoot" `
          -DCMAKE_BUILD_TYPE=${{ matrix.configuration }}
    
    - name: Build driver
      shell: powershell
      run: |
        cmake --build build --config ${{ matrix.configuration }} -j 4
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: usbchief-${{ matrix.arch }}-${{ matrix.configuration }}
        path: |
          build/${{ matrix.configuration }}/usbchief.sys
          build/${{ matrix.configuration }}/usbchief.pdb
        if-no-files-found: error
    
    - name: List build output
      shell: powershell
      run: |
        Write-Host "Build directory contents:"
        Get-ChildItem -Recurse build | Select-Object FullName
